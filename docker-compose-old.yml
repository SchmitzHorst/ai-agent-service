services:
  agent-service:
    build:
      context: .
      dockerfile: Dockerfile
    image: agent-service:latest
    container_name: agent-service
    restart: unless-stopped
    
    environment:
      # Anthropic API
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      
      # Paths (inside container)
      - PYTHON_SCRIPT_PATH=/app/python
      - PYTHON_VENV_PATH=/app/python/venv
      - TEMPLATE_REPO_PATH=/app/template
      - OUTPUT_APPS_PATH=/app/generated-apps
      
      # Deployment configuration
      - DEPLOYMENT_SERVER_HOST=localhost
      - DEPLOYMENT_SERVER_USER=root
      - DEPLOYMENT_SERVER_KEY_PATH=/app/keys/deploy_key
      - DEPLOYMENT_SERVER_TARGET_DIR=/opt/apps
      
      # Server configuration
      - SERVER_PORT=8081
      - SPRING_PROFILES_ACTIVE=prod
    
    volumes:
      # Generated apps (persistent)
      - ./generated-apps:/app/generated-apps
      
      # Template repository (read-only)
      - ./spring-angular-hetzner-template:/app/template:ro
      
      # SSH key for deployment (read-only)
      - ~/.ssh/agent_deploy_rsa:/app/keys/deploy_key:ro
      
      # Docker socket for deployment (if deploying on same host)
      - /var/run/docker.sock:/var/run/docker.sock
    
    networks:
      - spring-angular-app_app-network
    
    labels:
      # Traefik configuration
      - 'traefik.enable=true'
      
      # HTTP router
      - 'traefik.http.routers.agent-service.rule=Host(`agent.ai-alpine.ch`)'
      - 'traefik.http.routers.agent-service.entrypoints=websecure'
      - 'traefik.http.routers.agent-service.tls.certresolver=letsencrypt'
      
      # Service
      - 'traefik.http.services.agent-service.loadbalancer.server.port=8081'
      
      # CORS middleware (allow all origins for public API)
      - 'traefik.http.middlewares.agent-cors.headers.accesscontrolallowmethods=GET,POST,OPTIONS'
      - 'traefik.http.middlewares.agent-cors.headers.accesscontrolalloworiginlist=*'
      - 'traefik.http.middlewares.agent-cors.headers.accesscontrolallowheaders=Content-Type'
      - 'traefik.http.routers.agent-service.middlewares=agent-cors'
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/api/agent/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  spring-angular-app_app-network:
    external: true
